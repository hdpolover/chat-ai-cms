<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat AI Widget Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .demo-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .demo-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .demo-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .code-block {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            overflow-x: auto;
            margin: 10px 0;
        }
        .widget-preview {
            text-align: center;
            padding: 20px;
            background: #e3f2fd;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <div class="demo-header">
            <h1>ðŸ¤– Chat AI Widget Demo</h1>
            <p>Embed intelligent chatbots on your website with a simple script tag</p>
        </div>

        <div class="demo-section">
            <h2>ðŸ“‹ How to Embed</h2>
            <p>Add this code to your website where you want the chat widget to appear:</p>
            <div class="code-block">
&lt;div id="chatai-widget" 
     data-bot-id="760f0f2b-5f67-48a9-940a-870f94a3c2f3"
     data-tenant-slug="demo-tenant"
     data-theme="blue"&gt;&lt;/div&gt;
&lt;script src="http://localhost:8000/static/chatai-widget.js"&gt;&lt;/script&gt;
            </div>
        </div>

        <div class="demo-section">
            <h2>ðŸŽ¨ Customization Options</h2>
            <div class="code-block">
data-theme="blue|green|purple|orange"    // Widget color theme
data-position="bottom-right|bottom-left"  // Widget position
data-greeting="Hello! How can I help?"    // Initial greeting message
data-placeholder="Type your message..."   // Input placeholder
data-height="400px"                       // Widget height
data-width="350px"                        // Widget width
            </div>
        </div>

        <div class="demo-section">
            <h2>ðŸš€ Live Demo</h2>
            <div class="widget-preview">
                <p><strong>Widget will appear below:</strong></p>
                <div id="chatai-widget" 
                     data-bot-id="d23ebf61-221a-4da8-b441-c3db418848ed"
                     data-tenant-slug="demo-tenant"
                     data-theme="blue"
                     data-greeting="Hello! I'm a customer support bot. I can help with billing, technical support, and account issues. How can I help you today?"
                     data-height="400px"
                     data-width="100%"
                     style="max-width: 600px; margin: 20px auto;"></div>
            </div>
        </div>

        <div class="demo-section">
            <h2>ðŸ“Š Features</h2>
            <ul>
                <li>âœ… Real-time AI-powered conversations</li>
                <li>âœ… Customizable themes and styling</li>
                <li>âœ… Mobile-responsive design</li>
                <li>âœ… Citation support for knowledge sources</li>
                <li>âœ… Session management and history</li>
                <li>âœ… Easy integration with any website</li>
                <li>âœ… No backend setup required</li>
            </ul>
        </div>
    </div>

    <!-- Chat Widget Script -->
    <script>
        (function() {
            // Chat AI Widget v1.0
            const API_BASE = 'http://localhost:8000';
            
            function createChatWidget(element) {
                const botId = element.getAttribute('data-bot-id');
                const tenantSlug = element.getAttribute('data-tenant-slug');
                const theme = element.getAttribute('data-theme') || 'blue';
                const greeting = element.getAttribute('data-greeting') || 'Hello! How can I help you?';
                const placeholder = element.getAttribute('data-placeholder') || 'Type your message...';
                const height = element.getAttribute('data-height') || '400px';
                const width = element.getAttribute('data-width') || '350px';
                
                if (!botId) {
                    element.innerHTML = '<p style="color: red;">Error: data-bot-id is required</p>';
                    return;
                }

                // Widget styles
                const styles = `
                    .chatai-widget {
                        width: ${width};
                        height: ${height};
                        border: 1px solid #ddd;
                        border-radius: 12px;
                        overflow: hidden;
                        display: flex;
                        flex-direction: column;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                        background: white;
                        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
                    }
                    .chatai-header {
                        background: ${getThemeColor(theme)};
                        color: white;
                        padding: 16px;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    }
                    .chatai-messages {
                        flex: 1;
                        overflow-y: auto;
                        padding: 16px;
                        display: flex;
                        flex-direction: column;
                        gap: 12px;
                    }
                    .chatai-message {
                        display: flex;
                        gap: 8px;
                        animation: fadeIn 0.3s ease-in;
                    }
                    @keyframes fadeIn {
                        from { opacity: 0; transform: translateY(10px); }
                        to { opacity: 1; transform: translateY(0); }
                    }
                    .chatai-message.user {
                        flex-direction: row-reverse;
                    }
                    .chatai-avatar {
                        width: 32px;
                        height: 32px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        flex-shrink: 0;
                        font-size: 16px;
                    }
                    .chatai-avatar.bot {
                        background: ${getThemeColor(theme)};
                        color: white;
                    }
                    .chatai-avatar.user {
                        background: #e0e0e0;
                        color: #666;
                    }
                    .chatai-bubble {
                        max-width: 80%;
                        padding: 12px 16px;
                        border-radius: 18px;
                        line-height: 1.4;
                        word-wrap: break-word;
                    }
                    .chatai-bubble.bot {
                        background: #f1f3f4;
                        color: #333;
                        border-bottom-left-radius: 4px;
                    }
                    .chatai-bubble.user {
                        background: ${getThemeColor(theme)};
                        color: white;
                        border-bottom-right-radius: 4px;
                    }
                    .chatai-input-area {
                        padding: 16px;
                        border-top: 1px solid #eee;
                        display: flex;
                        gap: 8px;
                        align-items: flex-end;
                    }
                    .chatai-input {
                        flex: 1;
                        border: 1px solid #ddd;
                        border-radius: 20px;
                        padding: 12px 16px;
                        outline: none;
                        font-family: inherit;
                        resize: none;
                        min-height: 20px;
                        max-height: 100px;
                    }
                    .chatai-input:focus {
                        border-color: ${getThemeColor(theme)};
                    }
                    .chatai-send-btn {
                        background: ${getThemeColor(theme)};
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 40px;
                        height: 40px;
                        cursor: pointer;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 16px;
                        transition: all 0.2s;
                    }
                    .chatai-send-btn:hover:not(:disabled) {
                        opacity: 0.8;
                        transform: scale(1.05);
                    }
                    .chatai-send-btn:disabled {
                        opacity: 0.5;
                        cursor: not-allowed;
                    }
                    .chatai-loading {
                        display: flex;
                        align-items: center;
                        gap: 4px;
                        color: #666;
                        font-style: italic;
                    }
                    .chatai-dot {
                        width: 6px;
                        height: 6px;
                        border-radius: 50%;
                        background: ${getThemeColor(theme)};
                        animation: pulse 1.4s infinite both;
                    }
                    .chatai-dot:nth-child(2) { animation-delay: 0.2s; }
                    .chatai-dot:nth-child(3) { animation-delay: 0.4s; }
                    @keyframes pulse {
                        0%, 80%, 100% { opacity: 0.3; }
                        40% { opacity: 1; }
                    }
                    .chatai-citations {
                        margin-top: 8px;
                        display: flex;
                        flex-wrap: wrap;
                        gap: 4px;
                    }
                    .chatai-citation {
                        background: rgba(0,0,0,0.1);
                        color: #666;
                        padding: 2px 6px;
                        border-radius: 10px;
                        font-size: 11px;
                        text-decoration: none;
                    }
                `;

                function getThemeColor(theme) {
                    const themes = {
                        blue: '#2196F3',
                        green: '#4CAF50', 
                        purple: '#9C27B0',
                        orange: '#FF9800',
                    };
                    return themes[theme] || themes.blue;
                }

                // Create widget HTML
                element.innerHTML = `
                    <style>${styles}</style>
                    <div class="chatai-widget">
                        <div class="chatai-header">
                            <span>ðŸ¤–</span>
                            <span>Chat Assistant</span>
                        </div>
                        <div class="chatai-messages" id="messages-${botId}">
                            <div class="chatai-message">
                                <div class="chatai-avatar bot">ðŸ¤–</div>
                                <div class="chatai-bubble bot">${greeting}</div>
                            </div>
                        </div>
                        <div class="chatai-input-area">
                            <textarea 
                                class="chatai-input" 
                                id="input-${botId}"
                                placeholder="${placeholder}"
                                rows="1"></textarea>
                            <button class="chatai-send-btn" id="send-${botId}" type="button">âž¤</button>
                        </div>
                    </div>
                `;

                // Widget functionality
                const messagesContainer = document.getElementById(`messages-${botId}`);
                const input = document.getElementById(`input-${botId}`);
                const sendBtn = document.getElementById(`send-${botId}`);
                let sessionId = null;
                let isLoading = false;

                // Auto-resize textarea
                input.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                });

                // Send message on Enter (but allow Shift+Enter for new lines)
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });

                sendBtn.addEventListener('click', sendMessage);

                function addMessage(content, isUser, citations = []) {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `chatai-message ${isUser ? 'user' : ''}`;
                    
                    const citationsHtml = citations.length > 0 ? 
                        `<div class="chatai-citations">
                            ${citations.map(c => `<a href="${c.url || '#'}" class="chatai-citation" target="_blank">${c.source}</a>`).join('')}
                        </div>` : '';
                    
                    messageDiv.innerHTML = `
                        <div class="chatai-avatar ${isUser ? 'user' : 'bot'}">
                            ${isUser ? 'ðŸ‘¤' : 'ðŸ¤–'}
                        </div>
                        <div class="chatai-bubble ${isUser ? 'user' : 'bot'}">
                            ${content}
                            ${citationsHtml}
                        </div>
                    `;
                    
                    messagesContainer.appendChild(messageDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    return messageDiv;
                }

                function showLoading() {
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'chatai-message';
                    loadingDiv.id = 'loading-message';
                    loadingDiv.innerHTML = `
                        <div class="chatai-avatar bot">ðŸ¤–</div>
                        <div class="chatai-loading">
                            <div class="chatai-dot"></div>
                            <div class="chatai-dot"></div>
                            <div class="chatai-dot"></div>
                        </div>
                    `;
                    messagesContainer.appendChild(loadingDiv);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }

                function hideLoading() {
                    const loading = document.getElementById('loading-message');
                    if (loading) loading.remove();
                }

                async function sendMessage() {
                    const message = input.value.trim();
                    if (!message || isLoading) return;

                    isLoading = true;
                    sendBtn.disabled = true;
                    input.disabled = true;

                    // Add user message
                    addMessage(message, true);
                    input.value = '';
                    input.style.height = 'auto';

                    // Show loading
                    showLoading();

                    try {
                        // Use public chat API
                        const response = await fetch(`${API_BASE}/v1/chat/public`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                bot_id: botId,
                                messages: [{ role: 'user', content: message }],
                                session_id: sessionId,
                                metadata: { source: 'widget' }
                            })
                        });

                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }

                        const data = await response.json();
                        
                        hideLoading();
                        
                        console.log('API Response:', data); // Debug log
                        
                        if (data.message && data.message.content) {
                            addMessage(data.message.content, false, data.citations || []);
                            if (data.session_id) {
                                sessionId = data.session_id;
                            }
                        } else if (data.response) {
                            // Handle alternative response format
                            addMessage(data.response, false, data.citations || []);
                            if (data.session_id) {
                                sessionId = data.session_id;
                            }
                        } else {
                            console.error('Unexpected response format:', data);
                            addMessage('Sorry, I received an unexpected response format. Please try again.', false);
                        }

                    } catch (error) {
                        hideLoading();
                        console.error('Chat error details:', error);
                        console.error('Error message:', error.message);
                        console.error('Error stack:', error.stack);
                        addMessage(`Connection error: ${error.message}. Please check console for details.`, false);
                    } finally {
                        isLoading = false;
                        sendBtn.disabled = false;
                        input.disabled = false;
                        input.focus();
                    }
                }

                // Focus input initially
                setTimeout(() => input.focus(), 100);
            }

            // Initialize all widgets on page
            document.addEventListener('DOMContentLoaded', function() {
                const widgets = document.querySelectorAll('#chatai-widget');
                widgets.forEach(createChatWidget);
            });

            // Also initialize if script loads after DOM
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    const widgets = document.querySelectorAll('#chatai-widget');
                    widgets.forEach(createChatWidget);
                });
            } else {
                const widgets = document.querySelectorAll('#chatai-widget');
                widgets.forEach(createChatWidget);
            }
        })();
    </script>
</body>
</html>